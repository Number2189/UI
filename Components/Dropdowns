local utils = loadstring(game:HttpGet(GithubDirectory("Utils")))()

local dropdowns = {}

local runservice = game:GetService("RunService")

function dropdowns.Create(parent, theme, text, options, default, callback)
    local windowHolderParent = nil
    local mainFrame = nil
    
    if game.CoreGui:FindFirstChild("PCMenu") then
        windowHolderParent = game.CoreGui.PCMenu.WindowHolder
        if windowHolderParent then
            mainFrame = windowHolderParent:FindFirstChild("Main")
        end
    elseif game.CoreGui:FindFirstChild("VRMenu") then
        windowHolderParent = game.CoreGui.VRMenu.WindowHolder
        if windowHolderParent then
            mainFrame = windowHolderParent:FindFirstChild("Main")
        end
    end
    
    if not mainFrame then
        warn("Dropdown: Could not find Main frame")
        return {Instance = nil, Set = function() end, Get = function() return default or options[1] end}
    end

    local dropdown = Instance.new("Frame")
    dropdown.Name = "Dropdown"
    dropdown.Parent = parent
    dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    dropdown.BorderSizePixel = 0
    dropdown.Size = UDim2.new(1, 0, 0, 25)
    dropdown.ZIndex = 38
    utils.CreateCorner(dropdown, 4) 
    utils.CreateStroke(dropdown)

    local label = Instance.new("TextButton")
    label.Parent = dropdown
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0, 10, 0, 0)
    label.Size = UDim2.new(1, -50, 1, 0)
    label.Font = Enum.Font.SourceSans
    label.Text = text .. ": " .. (default or options[1])
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.ZIndex = 39

    local togglebutton = Instance.new("TextButton")
    togglebutton.Parent = dropdown
    togglebutton.BackgroundTransparency = 1
    togglebutton.Position = UDim2.new(1, -40, 0, 0)
    togglebutton.Size = UDim2.new(0, 30, 1, 0)
    togglebutton.Text = "▼"
    togglebutton.TextColor3 = Color3.fromRGB(255, 255, 255)
    togglebutton.TextSize = 12
    togglebutton.ZIndex = 39

    local optioncontainer = Instance.new("Frame")
    optioncontainer.Name = "OptionContainer"
    optioncontainer.Parent = mainFrame
    optioncontainer.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    optioncontainer.BorderSizePixel = 0
    optioncontainer.Size = UDim2.new(0, 220, 0, 0)
    optioncontainer.Visible = false
    optioncontainer.ZIndex = 40
    utils.CreateCorner(optioncontainer, 6)
    utils.CreateStroke(optioncontainer)

    local isopen = false
    local currentoption = default or options[1]

    local function updatedropdown()
        label.Text = text .. ": " .. currentoption
        if callback then callback(currentoption) end
    end

    local overlay = dropdownOverlay
    if not overlay then
        overlay = Instance.new("Frame")
        overlay.Name = "DropdownOverlay"
        overlay.Size = UDim2.new(1, 0, 1, 0)
        overlay.BackgroundTransparency = 1
        overlay.BackgroundColor3 = Color3.new(0,0,0)
        overlay.ZIndex = 99
        overlay.Parent = mainFrame
    end
    local dim = overlay:FindFirstChild("DropdownDim")
    if not dim then
        dim = Instance.new("Frame")
        dim.Name = "DropdownDim"
        dim.Size = UDim2.new(1, 0, 1, 0)
        dim.BackgroundColor3 = Color3.new(0,0,0)
        dim.BackgroundTransparency = 1
        dim.ZIndex = 100
        dim.Parent = overlay
    end

    local function toggledropdown()
        isopen = not isopen
        togglebutton.Text = isopen and "▲" or "▼"
        optioncontainer.Visible = isopen
        if isopen then
            if dimmed_wso then return end
            local targetheight = math.min(#options, 8) * 28 + 12
            if dim then
                overlay.Visible = true
                dim.Visible = true
                utils.Tween(dim, {BackgroundTransparency = 0.7}, 0.22):Play()
            end
            utils.SpringTween(optioncontainer, {Size = UDim2.new(0, 220, 0, targetheight)}):Play()
            optioncontainer.Position = UDim2.new(0.5, -110, 0.5, -50)
            dimmed_wso = true
        else
            runservice:UnbindFromRenderStep("DropdownCenter")
            utils.Tween(optioncontainer, {Size = UDim2.new(0, 220, 0, 0)}, 0.2):Play()
            task.delay(0.22, function()
                if not isopen then
                    optioncontainer.Visible = false
                    utils.Tween(dim, {BackgroundTransparency = 1}, 0.22):Play()
                    task.delay(0.12, function()
                        dim.Visible = false
                    end)
                    overlay.Visible = false
                    dimmed_wso = false
                end
            end)
        end
    end

    for _, option in pairs(options) do
        local optionbutton = Instance.new("TextButton")
        optionbutton.Name = "OptionButton"
        optionbutton.Parent = optioncontainer
        optionbutton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        optionbutton.BorderSizePixel = 0
        optionbutton.Size = UDim2.new(1, -12, 0, 26)
        optionbutton.Position = UDim2.new(0, 6, 0, 6 + (_ - 1) * 28)
        optionbutton.Text = option
        optionbutton.TextColor3 = Color3.fromRGB(255, 255, 255)
        optionbutton.TextSize = 12
        optionbutton.Font = Enum.Font.SourceSans
        optionbutton.ZIndex = 41
        utils.CreateCorner(optionbutton, 4)

        optionbutton.MouseEnter:Connect(function()
            utils.Tween(optionbutton, {BackgroundColor3 = Color3.fromRGB(50, 50, 50)}):Play()
        end)
        optionbutton.MouseLeave:Connect(function()
            utils.Tween(optionbutton, {BackgroundColor3 = Color3.fromRGB(40, 40, 40)}):Play()
        end)
        optionbutton.MouseButton1Click:Connect(function()
            currentoption = option
            dimmed_wso = false
            updatedropdown()
            toggledropdown()
        end)
    end

    label.MouseButton1Click:Connect(toggledropdown)
    togglebutton.MouseButton1Click:Connect(toggledropdown)

    return {
        Instance = dropdown,
        Set = function(value)
            if table.find(options, value) then
                currentoption = value
                updatedropdown()
            end
        end,
        Get = function()
            return currentoption
        end
    }
end

return dropdowns
